{
  "hash": "4d29ca6e9725c30b1abe1e6579e82f7b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"BC Election 2024\"\nauthor:\n  - name: Jens von Bergmann\ndate: '2024-10-20'\nlast-modified: '2024-10-28'\nslug: bc-election-2024\ndescription: \"A quick updated on the \\\"land doesn't vote, people do\\\" theme.\"\nimage: 'images/land_vs_people.png'\ncategories:\n  - geeky\nbibliography: ../../common_literature.bib \ncode-tools:\n  toggle: true\nfig-width: 8\nexecute:\n  cache: false\n  message: false\n  warning: false\n---\n\n\n\n\nWe don't yet have the final results for the 2024 BC provincial election, we are still waiting on the count of the vote-by-mail ballots that have not arrived yet. Some ridings are still in limbo, as is the overall outcome and who will form government.\n\nBut most ridings have been called and we wanted to take this opportunity to replicate a map highlighting the difference between land and people as we have done for earlier federal elections, following the idea [implemented for the 2016 US presidential elections](https://observablehq.com/@karimdouieb/try-to-impeach-this-challenge-accepted) by [Karim Dou√Øeb](http://twitter.com/karim_douieb). [@elections-fun.2019; @elections-fun-2021-edition.2021]\n\nAs opposed to last time, we can now render the animation live within this blog, thanks quarto's direct support for [observable js](https://observablehq.com/documentation/cells/observable-javascript). All it takes is a little bit of data prep, where we grab the electoral district boundaries, cut out water features and simplify the polygons. And then scrape the election results from Elections BC. (It's 2024 and they probably have an actual data feed, but they sure make it hard to find.) Then we assemble a list of ridings that have not been called by hand, we will update that as more results come in.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(mountainmathHelpers)\nlibrary(sf)\n\n\ndistrict_boundaries <- simpleCache({\n  bc_geo <- cancensus::get_statcan_geographies(\"2021\",\"PR\") |>\n    filter(PRUID==\"59\") |>\n    rmapshaper::ms_simplify() |>\n    st_make_valid()\n  \n  read_sf(\"~/Downloads/BCGW_7113060B_1729362546577_9396/EBC_ELECTORAL_DISTS_BS11_SVW/EBC_ED_23_polygon.shp\") |>\n    select(ED_ID,ED_ABBREV,ED_NAME,geometry) %>%\n    rmapshaper::ms_simplify() %>%\n    st_intersection(st_transform(bc_geo,st_crs(.))) %>%\n    rmapshaper::ms_simplify() %>%\n    st_make_valid() %>%\n    st_cast(\"MULTIPOLYGON\") |>\n    mutate(x=st_coordinates(st_centroid(geometry))[,1],y=st_coordinates(st_centroid(geometry))[,2]) %>%\n    arrange(-y) |>\n    mutate(rank = row_number()) |>\n    st_cast(\"POLYGON\") |>\n    mutate(area=st_area(geometry) |> as.numeric()) %>%\n    mutate(mainShape=area==max(area),.by=ED_ID)\n},\"bc_election_polygons.rds\")\n\nupload_result <- district_boundaries |>\n  select(ED_ID,ED_NAME,x,y,rank,mainShape,geometry) |>\n  sf_to_s3_gzip(\"mountainmath\",\"bc_2024_elections/district_boundaries.geojson\")\n\n\nresults_raw <- rvest::read_html(\"https://electionsbcenr.blob.core.windows.net/electionsbcenr/Results_7097_GE-2024-10-19_Candidate.html\") |>\n  rvest::html_nodes(\"table#tblReport\") |>\n  rvest::html_table() |>\n  first() |>\n  select(ED_NAME=`Electoral District`,Candidate=`Candidate's Ballot Name`,Party=Affiliation,Votes=`Total Valid Votes`,Share=`% of Votes`) |>\n  mutate(ED_NAME = na_if(ED_NAME,\"\")) |>\n  fill(ED_NAME,.direction = \"down\") %>%\n  mutate(across(c(Candidate,Party), \\(x)if_else(.$Candidate==\"\" & .$Party==\"\",\"Total\",x))) |>\n  mutate(Party=if_else(Party==\"\",\"Unaffiliated\",Party)) |>\n  mutate(Votes=gsub(\",\",\"\",Votes) |> as.numeric(),\n         Share=as.numeric(gsub(\"\\\\%\",\"\",Share))/100) \n\n\nclose_races <- c(\n  \"Coquitlam-Burke Mountain\",\n  \"Courtenay-Comox\",\n  \"Juan de Fuca-Malahat\",\n  \"Kelowna Centre\",\n  \"Maple Ridge East\",\n  \"Richmond-Steveston\",\n  \"Surrey City Centre\",\n  \"Surrey-Guildford\",\n  \"Surrey-Panorama\",\n  \"Vancouver-Langara\",\n  \"Vernon-Lumby\"\n)\n\nopen_races <- c(\n  #\"Coquitlam-Burke Mountain\",\n  # \"Courtenay-Comox\",\n  # \"Juan de Fuca-Malahat\",\n  # \"Kelowna Centre\",\n  #\"Maple Ridge East\",\n  #\"Richmond-Steveston\",\n  #\"Surrey City Centre\",\n  # \"Surrey-Guildford\"\n  #\"Surrey-Panorama\",\n  #\"Vancouver-Langara\",\n  #\"Vernon-Lumby\"\n)\n\nresults <- results_raw |>\n  filter(!grepl(\"Advance voting ballot boxes|Final Voting Day ballot boxes|Out-of-district ballots|Status | In Progress| Complete\",ED_NAME)) |>\n  left_join(district_boundaries |> st_drop_geometry() |> select(ED_NAME,ED_ID) |> unique(),by=c(\"ED_NAME\"=\"ED_NAME\")) |>\n  mutate(close=ED_NAME %in% close_races,\n         called=!(ED_NAME %in% open_races))\n\ntmp <- tempfile(fileext = \".csv\")\ncleaned_results <- results |> \n  filter(Party!=\"Total\") |>\n  mutate(Party=recode(Party,\"BC NDP\"=\"NDP\",\"BC Green Party\"=\"GRN\",\"Conservative Party\"=\"CON\",\"Independent\"=\"IND\",\n                      \"Freedom Party of BC\"=\"FP\",\"Libertarian\"=\"LTN\",\"Christian Heritage Party of B.C.\"=\"CHP\",\n                      \"Communist Party of BC\"=\"COM\" ))\ncleaned_results |>\n  select(ED_ID,Candidate,Party,Votes,called) |> \n  write_csv( tmp)\nupload_result <- file_to_s3_gzip(tmp,\n                                 \"mountainmath\",\n                                 \"bc_2024_elections/results.csv\")\n```\n:::\n\n\n\n\nWith the data in hand^[We placed the data separately online to not interfere with page loading, and load it separately in via javascript.] we can on observable to draw our map. Regions that have not yet been called are coloured in a lighter shade of the party that is currently in the lead. The tooltip on hover shows the full riding results.\n\n\n\n\n```{ojs}\n//| label: fig-land-vs-people\n//| fig-cap: 'Land does not vote, people do'\n\nvote_map_animation = {\n  const height = width*ratio ;\n  \n  const tooltip = d => [\n        `${d.properties.ED_NAME}`,\n        (d.properties.called ? `Winner: ` : `Leading: `) + `${d.properties.winner.Candidate} - (${d.properties.winner.Party})`,\n        `Margin: ${format.comma(d.properties.results[0].Votes - d.properties.results[1].Votes)} (${format.percent((d.properties.results[0].Votes - d.properties.results[1].Votes)/d.properties.Total)})`,\n        \"\",\n        ...d.properties.results.map(p => `${p.Candidate} - (${p.Party}): ${format.comma(p.Votes)} (${format.percent(p.Votes/d.properties.Total)})`)\n        ].join(\"\\n\")\n\n  \n  const svg = d3.select(DOM.svg(width, height))\n      .attr(\"viewBox\", \"0 0 960 600\")\n      .style(\"width\", \"100%\")\n      .style(\"height\", \"auto\");\n  \n  // render map\n  const path = d3.geoPath(projection)\n\n   svg.append(\"g\")\n     .selectAll(\"path\")\n     .data(districts)\n     .enter().append(\"path\")\n     .attr(\"class\", \"bcDistrict\")\n     .attr(\"fill\", district => district.properties.called ? party_colors[district.properties.winner.Party] : party_colors2[district.properties.winner.Party])  \n     .attr(\"d\", path)\n     .attr(\"stroke\", \"white\")\n     .attr(\"stroke-width\", 0.5)\n     .append(\"title\")\n     .text(tooltip) \n   \n  setInterval(() => {\n    svg.selectAll(\".bcDistrict\")\n      .transition()\n      .delay(d => d.properties.rank*20)\n      .duration(5000)\n      .attrTween('d', function(d, i) {\n        return flubber.toCircle(path(d), d.x, d.y, d.properties.radius, {maxSegmentLength: 2});\n      })\n\n    svg.selectAll(\".bcDistrict\")\n      .transition()\n      .delay(d => 10000 + d.properties.rank*20)\n      .duration(5000)\n      .attrTween('d', function(d, i) {\n        return flubber.fromCircle(d.x, d.y, d.properties.radius, path(d), {maxSegmentLength: 2});\n      })\n  }, 25000)\n\n  return svg.node();\n}\n```\n\n\n\nThe animation interpolates between the geographies of the ridings, and bubbles for each riding of size proportional to the total vote count. This visualizes the degree to which the map view over-emphasizes rural areas, which predominantly went to the Conservatives, whereas electoral districts with high population density and consequently lower area were predominantly won by the NDP.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlead_results <- cleaned_results |> \n  group_by(ED_ID) |>\n  arrange(-Votes) |>\n  mutate(lead=Votes-lead(Votes),\n         Total=sum(Votes)) |>\n  slice_max(Votes,n=1) |>\n  ungroup() |>\n  mutate(lead_share=lead/Total) \n\ntightest_race <- lead_results |> slice_min(lead_share,n=1) \n```\n:::\n\n\n\n\nSome ridings had a clear winner with a large lead, others are still quite tight. @fig-party-lead-by-riding we give an overview over the vote share lead in each riding, the tightest race right now is Surrey-Guildford, where the NDP currently holds a 22 vote (0.1 percentage point) lead.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparty_colours <- c(\n  CON=\"#115DA8\",\n    NDP=\"#F58220\",\n    IND=\"#676767\",\n    GRN=\"#3D9B35\"\n)\nparty_colours2 <- c(\n  CON=\"#83ACF5\",\n    NDP=\"#FFB38D\",\n    IND=\"#FFCBB8\",\n    GRN=\"#84DA80\"\n)\nparty_colours_combined <- c(party_colours,setNames(as.character(party_colours2),paste0(names(party_colours2),\" (lead)\")))\n\n\nlead_results |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in each riding\",\n       x=\"Percentage point lead\",\n       y=NULL,fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![The vote share margind by which each party candidate is currently in the lead in each riding.](index_files/figure-html/fig-party-lead-by-riding-1.png){#fig-party-lead-by-riding width=768}\n:::\n:::\n\n\n\n## Update (Oct 23, 2024)\n\nElections BC is still regularly updating vote counts, for convenience we added a graph with just the 11 races that CBC has not yet called. We will updated this regularly as updated voting results come in. Fore reference we kept some of the older version in the tabs.\n\n::: {.panel-tabset}\n\n## Nov 8, 2024\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache(lead_results,\"bc_elections_2024_results-2024-11-08.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 28, 2024 - 6:50pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-6:50pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=768}\n:::\n:::\n\n\n\n\n## Oct 28, 2024 - 5pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-5pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=768}\n:::\n:::\n\n\n\n\n## Oct 28, 2024 - 4pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-4pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=768}\n:::\n:::\n\n\n\n\n## Oct 28, 2024 - 3pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-3pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 28, 2024 - 2pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-2pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 28, 2024 - 1pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-1pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 28, 2024 - 12pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-12pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 28, 2024 - 11am\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-11am.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 28, 2024 - 10am\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-28-10am.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=768}\n:::\n:::\n\n\n\n\n<!--## Oct 28, 2024 - 9am-->\n\n\n\n::: {.cell}\n\n:::\n\n\n\n## Oct 27, 2024 - 8:30pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-27-8pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 27, 2024 - 5:40pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-27-5pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=768}\n:::\n:::\n\n\n\n<!--## Oct 27, 2024 - 4pm-->\n\n\n\n::: {.cell}\n\n:::\n\n\n\n## Oct 27, 2024 - 1pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-27-1pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 26, 2024 - 4pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-26-4pm.rds\") |>\n  filter(close) |>\n  mutate(Party_call=paste0(Party, ifelse(called,\"\",\" (lead)\"))) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party_call))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours_combined,breaks=names(party_colours)) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL,\n       fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 26, 2024 - 1pm\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-26-1pm.rds\") |>\n  filter(close) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours2) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  guides(fill=guide_legend(override.aes=list(fill=party_colours[c(\"CON\",\"NDP\")]))) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL, fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=768}\n:::\n:::\n\n\n\n## Oct 25, 2024\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimpleCache({},\"bc_elections_2024_results-2024-10-25.rds\") |>\n  mutate(close=!called) |>\n  filter(close) |>\n  ggplot(aes(x=lead_share,y=reorder(ED_NAME,lead_share),fill=Party))  +\n  geom_bar(stat=\"identity\") +\n  geom_text(aes(label=scales::comma(lead,suffix=\" vote lead\"),hjust=ifelse(lead_share>0.01,1.1,-0.1))) +\n  scale_fill_manual(values=party_colours2) +\n  scale_x_continuous(labels=\\(d)scales::percent(d,suffix=\"pp\")) +\n  guides(fill=guide_legend(override.aes=list(fill=party_colours[c(\"CON\",\"NDP\")]))) +\n  labs(title=\"Party lead in races CBC has not called yet\",\n       x=\"Percentage point vote lead\",\n       y=NULL, fill=\"Party\",\n       caption=\"Data: Elections BC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=768}\n:::\n:::\n\n\n\n\n:::\n\n\n<details>\n<summary>Remaining Observable code</summary>\n\n\n\n```{ojs}\napplySimulation = (nodes) => {\n  const simulation = d3.forceSimulation(nodes)\n    .force(\"cx\", d3.forceX().x(d => width / 2).strength(0.02))\n    .force(\"cy\", d3.forceY().y(d => width * (5/8) / 2).strength(0.02))\n    .force(\"x\", d3.forceX().x(d => projection([d.properties.x,d.properties.y])[0]).strength(0.3))\n    .force(\"y\", d3.forceY().y(d => projection([d.properties.x,d.properties.y])[1]).strength(0.3))\n    .force(\"charge\", d3.forceManyBody().strength(-1))\n    .force(\"collide\", d3.forceCollide().radius(d => d.properties.radius + nodePadding).strength(1))\n    .stop()\n\n  let i = 0; \n  while (simulation.alpha() > 0.01 && i < 250) {\n    simulation.tick(); \n    i++;\n    //console.log(`${Math.round(100*i/200)}%`)\n  }\n\n  return simulation.nodes();\n}\n```\n\n```{ojs}\nspreadDistricts = applySimulation(districts)\n```\n\n```{ojs}\nmaxRadius = 15\n```\n\n```{ojs}\nratio = 1\n```\n\n```{ojs}\nnodePadding = 0.3\n```\n\n```{ojs}\nparty_colors = {\n  return {\n    CON:\"#115DA8\",\n    NDP:\"#F58220\",\n    IND:\"#676767\",\n    GRN:\"#3D9B35\"\n  }\n}\n```\n\n```{ojs}\nparty_colors2 = {\n  return {\n    CON:\"#83ACF5\",\n    NDP:\"#FFB38D\",\n    IND:\"#FFCBB8\",\n    GRN:\"#84DA80\"\n  }\n}\n```\n\n```{ojs}\nformat = ({\n  density: (x) => x > 1000 ? d3.format(\".2s\")(x) : d3.format(\".3r\")(x),\n  percent: d3.format(\".1%\"),\n  comma: d3.format(\",.0f\")\n})\n```\n\n```{ojs}\nprojection = d3.geoIdentity().reflectY(true).fitSize([960, 600], {type: \"FeatureCollection\", features: districts})\n```\n\n```{ojs}\ndistricts = bc_districts.features\n```\n\n```{ojs}\nbc_districts = { \n  const url = \"https://mountainmath.s3.ca-central-1.amazonaws.com/bc_2024_elections/district_boundaries.geojson\";\n  const bc_districts = await d3.json(url);\n  const bc_results_all = await d3.csv(\"https://mountainmath.s3.ca-central-1.amazonaws.com/bc_2024_elections/results.csv\")\n    \n    \n  const bc_results =  [...new Set(bc_results_all.map(d => d.ED_ID))]\n    .reduce((hash, elem) => {\n      const rs = bc_results_all.filter(r => r.ED_ID === elem)\n        .map(d=> {d.Votes=parseInt(d.Votes);\n                  return(d)})\n        .sort((a,b) => b.Votes-a.Votes)\n      hash[elem] = {results:rs,\n                    Total:d3.sum(rs, d => d.Votes),\n                    called:rs[0].called===\"TRUE\",\n                    winner:rs[0]}\n      return hash\n          }, {})\n  \n  const voteMax = d3.max(Object.keys(bc_results), d => bc_results[d].Total)\n  const radiusScale = d3.scaleSqrt()\n      .domain([0, voteMax])\n      .range([1, maxRadius]) \n  \n  bc_districts.features.forEach(d => {\n    const rp = bc_results[d.properties.ED_ID.toString()]\n      d.properties = {\n        ...d.properties,\n        ...rp,\n        radius: d.properties.mainShape ? radiusScale(rp.Total) : 0\n      }\n  })\n  return bc_districts;\n}\n```\n\n```{ojs}\nd3 = require(\"d3@5\")\n```\n\n```{ojs}\nturf = require(\"@turf/turf@5\")\n```\n\n```{ojs}\nflubber = require('https://unpkg.com/flubber')\n```\n\n\n\n</details>\n\nAs usual, the code for this post is [available on GitHub](https://github.com/mountainMath/mountain_doodles/blob/main/posts/2024-10-20-bc-election-2024/index.qmd) for anyone to reproduce or adapt for their own purposes.\n\n\n<details>\n\n<summary>Reproducibility receipt</summary>\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## datetime\nSys.time()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"2024-11-08 14:43:48 PST\"\n```\n\n\n:::\n\n```{.r .cell-code}\n## repository\ngit2r::repository()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLocal:    main /Users/jens/R/mountain_doodles\nRemote:   main @ origin (https://github.com/mountainMath/mountain_doodles.git)\nHead:     [4bf0a38] 2024-10-30: freeze for final count of bc election results (not yet accounting for manual recounts).\n```\n\n\n:::\n\n```{.r .cell-code}\n## Session info\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.4.1 (2024-06-14)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS 15.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: America/Vancouver\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] sf_1.0-16                 mountainmathHelpers_0.1.4\n [3] lubridate_1.9.3           forcats_1.0.0            \n [5] stringr_1.5.1             dplyr_1.1.4              \n [7] purrr_1.0.2               readr_2.1.5              \n [9] tidyr_1.3.1               tibble_3.2.1             \n[11] ggplot2_3.5.1             tidyverse_2.0.0          \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.5        xfun_0.47           htmlwidgets_1.6.4  \n [4] websocket_1.4.1     processx_3.8.4      tzdb_0.4.0         \n [7] ps_1.7.6            vctrs_0.6.5         tools_4.4.1        \n[10] generics_0.1.3      parallel_4.4.1      curl_5.2.2         \n[13] proxy_0.4-27        fansi_1.0.6         pkgconfig_2.0.3    \n[16] R.oo_1.26.0         KernSmooth_2.23-24  lifecycle_1.0.4    \n[19] git2r_0.33.0        farver_2.1.2        compiler_4.4.1     \n[22] munsell_0.5.1       chromote_0.2.0      htmltools_0.5.8.1  \n[25] class_7.3-22        yaml_2.3.10         crayon_1.5.2       \n[28] later_1.3.2         pillar_1.9.0        R.utils_2.12.3     \n[31] aws.s3_0.3.21       classInt_0.4-10     mime_0.12          \n[34] tidyselect_1.2.1    rvest_1.0.4         digest_0.6.37      \n[37] stringi_1.8.4       labeling_0.4.3      fastmap_1.2.0      \n[40] grid_4.4.1          colorspace_2.1-0    cli_3.6.3          \n[43] magrittr_2.0.3      base64enc_0.1-3     utf8_1.2.4         \n[46] e1071_1.7-14        aws.signature_0.6.0 withr_3.0.1        \n[49] promises_1.3.0      scales_1.3.0        bit64_4.0.5        \n[52] timechange_0.3.0    rmarkdown_2.28      httr_1.4.7         \n[55] bit_4.0.5           R.methodsS3_1.8.2   hms_1.1.3          \n[58] evaluate_1.0.0      knitr_1.48          rlang_1.1.4        \n[61] Rcpp_1.0.13         glue_1.8.0          DBI_1.2.3          \n[64] selectr_0.4-2       geojsonsf_2.0.3     xml2_1.3.6         \n[67] vroom_1.6.5         rstudioapi_0.16.0   jsonlite_1.8.8     \n[70] R6_2.5.1            units_0.8-5        \n```\n\n\n:::\n:::\n\n\n\n</details>\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}